From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Evan Maddock <maddock.evan@vivaldi.net>
Date: Wed, 5 Mar 2025 16:49:30 -0500
Subject: [PATCH 6/6] Only show drivers for your device

Signed-off-by: Evan Maddock <maddock.evan@vivaldi.net>
---
 .../PackageKitBackend/AppPackageKitResource.cpp        | 10 ++++++++++
 .../packagekit-backend-categories.xml                  | 10 ----------
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/libdiscover/backends/PackageKitBackend/AppPackageKitResource.cpp b/libdiscover/backends/PackageKitBackend/AppPackageKitResource.cpp
index 3b685fb41..8423f23a2 100644
--- a/libdiscover/backends/PackageKitBackend/AppPackageKitResource.cpp
+++ b/libdiscover/backends/PackageKitBackend/AppPackageKitResource.cpp
@@ -6,6 +6,7 @@
 
 #include "AppPackageKitResource.h"
 #include "utils.h"
+#include <AppStreamQt/component.h>
 #include <AppStreamQt/developer.h>
 #include <AppStreamQt/icon.h>
 #include <AppStreamQt/image.h>
@@ -120,6 +121,15 @@ bool AppPackageKitResource::hasCategory(const QString &category) const
 {
     if (m_appdata.kind() != AppStream::Component::KindAddon && category == QStringLiteral("Application"))
         return true;
+    if (m_appdata.kind() == AppStream::Component::KindDriver && category == QStringLiteral("Drivers")) {
+        const auto mods = m_appdata.provided(AppStream::Provided::KindModalias);
+        auto sys = AppStream::SystemInfo();
+        for (const auto &mod : mods.items()) {
+            if (sys.hasDeviceMatchingModalias(mod)) {
+                return true;
+            }
+        }
+    }
     return m_appdata.hasCategory(category);
 }
 
diff --git a/libdiscover/backends/PackageKitBackend/packagekit-backend-categories.xml b/libdiscover/backends/PackageKitBackend/packagekit-backend-categories.xml
index 9ce96987b..61e3102ac 100644
--- a/libdiscover/backends/PackageKitBackend/packagekit-backend-categories.xml
+++ b/libdiscover/backends/PackageKitBackend/packagekit-backend-categories.xml
@@ -562,16 +562,6 @@
         <Category>Drivers</Category>
       </And>
     </Include>
-    <Menu>
-      <Name>Drivers For This Device</Name>
-      <Icon>computer-laptop</Icon>
-      <Drivers />
-      <Include>
-        <And>
-          <Category>CompatibleDrivers</Category>
-        </And>
-      </Include>
-    </Menu>
   </Menu>
 
   <Menu>
